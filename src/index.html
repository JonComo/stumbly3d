<!DOCTYPE html>
<html>
  <head>
    <title>stumbly3d</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  </head>
  <body>

    <script src="build/cannon.js"></script>
    <script src="build/cannon.demo.js"></script>
    <script src="libs/dat.gui.js"></script>
    <script src="libs/Three.js"></script>
    <script src="libs/TrackballControls.js"></script>
    <script src="libs/Detector.js"></script>
    <script src="libs/Stats.js"></script>
    <script src="libs/smoothie.js"></script>
    <script src="libs/numeric-1.2.6.js"></script>

    <script>

    var demo = new CANNON.Demo();
    var mass = 1;
    var world;

    // RL
    var bodies = [];
    var joints = [];

    world = demo.getWorld();
    world.gravity.set(0,5,-20);

    function add_part(part) {
        world.addBody(part);
        demo.addVisual(part);
    }

    function add_box(x, y, z, sx, sy, sz) {
        let box = new CANNON.Body({ mass: mass });
        box.addShape(new CANNON.Box(Vec3(sx, sy, sz)));
        box.position = Vec3(x, y, z);
        add_part(box);
        bodies.push(box);
        return box;
    }

    function add_joint(a, b, pa, pb, axis) {
        var c = new CANNON.HingeConstraint(a, b, {
            pivotA: pa,
            axisA: axis,
            pivotB: pb,
            axisB: axis
        });

        c.enableMotor();
        c.setMotorMaxForce(1e8);
        world.addConstraint(c);
        joints.push(c);
        return c;
    }

    function Vec3(x, y, z) {
        return new CANNON.Vec3(x, y, z);
    }

    let b = add_box(0, 0, 0, 3, 1.5, .8);

    // legs
    let l = 4;
    let d = 2;
    let r1 = add_box(-2, 2, 0, l, .2, .2);
    let r2 = add_box(-2, -2, 0, l, .2, .2);
    let l1 = add_box(2, 2, 0, l, .2, .2);
    let l2 = add_box(2, -2, 0, l, .2, .2);

    let c1 = add_joint(b, r1, Vec3(-d, 1, 0), Vec3(1, -1, 0), Vec3(0, 1, 0));
    let c2 = add_joint(b, r2, Vec3(-d, -1, 0), Vec3(1, 1, 0), Vec3(0, 1, 0));
    let c3 = add_joint(b, l1, Vec3(d, 1, 0), Vec3(-1, -1, 0), Vec3(0, 1, 0));
    let c4 = add_joint(b, l2, Vec3(d, -1, 0), Vec3(-1, 1, 0), Vec3(0, 1, 0));

    // Ground
    var groundMaterial = new CANNON.Material("groundMaterial");
    var groundShape = new CANNON.Plane();
    var ground = new CANNON.Body({ mass: 0, material: groundMaterial });

    ground.addShape(groundShape);
    ground.position.z = -3;

    world.addBody(ground);
    demo.addVisual(ground);
    
    function features(bodies) {
        var fet = [];

        var eul = new CANNON.Vec3(0, 0, 0);
        for (var i = 0; i < bodies.length; i++) {
            var b = bodies[i];
            b.quaternion.toEuler(eul);
            fet = fet.concat([eul.x, eul.y, eul.z, Math.sin(eul.x), Math.sin(eul.y)]);
        }

        return fet;
    }

    function mat(r, c) {
        var s = 1.0;
        var mat = numeric.random([r, c]);
        mat = numeric.mul(mat, s);
        mat = numeric.add(mat, -s/2);
        return mat;
    }

    function mat_fn(m, fn) {
        var d = numeric.dim(m);
        var mcopy = numeric.random([d[0], d[1]]);
        for (var i = 0; i < d[0]; i++) {
            for (var j = 0; j < d[1]; j++) {
                mcopy[i][j] = fn(m[i][j]);
            }
        }
        return m;
    }

    // RL

    // matrices
    var X_DIM = features(bodies).length;
    var H_DIM = 20;
    var OUT_DIM = joints.length;

    var W1 = mat(H_DIM, X_DIM);
    var W2 = mat(OUT_DIM, H_DIM);

    window.onkeypress = function(evt) {
        console.log(evt);
        if (evt.key == "r") {
            W1 = mat(H_DIM, X_DIM);
            W2 = mat(OUT_DIM, H_DIM);
        }
    }

    var h2;
    
    function render() {
        requestAnimationFrame( render );

        for (var iter = 0; iter < 1; iter++) {
            world.step( 1/60 );
            
            
            var x = features(bodies);
            var z1 = numeric.dot(W1, x);

            h1 = mat_fn(z1, Math.tanh); // h1
            var z2 = numeric.dot(W2, h1);
            h2 = numeric.mul(z2, 1.0);
            
            for (let i = 0; i < OUT_DIM; i++) {
                joints[i].setMotorSpeed(h2[i]);
            }
        }

        demo.animate();
    }

    render();

    </script>
  </body>
</html>
